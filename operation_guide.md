# MediaPipe Pose Extractor 操作ガイド

## アプリの概要

MediaPipe Pose Extractor は、画像や動画から人物の骨格（ポーズ）を抽出するアプリケーションです。
AI画像生成の ControlNet（OpenPose）用の骨格画像や、モーション解析用のデータを簡単に作成できます。

---

## できること一覧

### 基本機能

| 機能 | 説明 |
|------|------|
| 骨格抽出 | 画像・動画から人物の骨格を検出し、骨格画像を生成 |
| JSON出力 | OpenPose互換形式のキーポイントデータを出力 |
| バッチ処理 | 複数ファイルを一括処理 |
| リアルタイムプレビュー | 処理前後の画像を確認 |

### 検出モード

| モード | 検出対象 | 用途 |
|--------|----------|------|
| Full Control (統合) | 体 + 手 + 顔 | 詳細な制御が必要な場合 |
| Simple Pose (簡易) | 体のみ | シンプルなポーズ抽出 |
| Pose + Hands | 体 + 手 | 手の動きも必要な場合 |

### カスタマイズ機能

- 骨格の線の太さ・色を自由に変更
- 背景色の指定（黒/白/グレー/カスタム）
- オーバーレイ表示（元画像と骨格を重ねて確認）

---

## 画面構成

### 画像処理タブ

```
┌─────────────────────────────────────┐
│ 入力ファイル [参照] [複数選択] [フォルダ] │
├─────────────────────────────────────┤
│ 基本設定                              │
│ ・モード  ・精度  ・閾値  ・保存先      │
├─────────────────────────────────────┤
│ 描画設定                              │
│ ・線の太さ  ・点の大きさ  ・背景色  ・色  │
├─────────────────────────────────────┤
│ [🚀 骨格を抽出] ████████░░ 80%       │
├─────────────────────────────────────┤
│  入力画像     │     骨格画像          │
│   プレビュー   │     プレビュー         │
├─────────────────────────────────────┤
│ 処理ログ                              │
└─────────────────────────────────────┘
```

### 動画処理タブ

画像処理タブと同様の構成で、動画ファイルを処理します。

---

## パラメータ解説

### 基本設定

#### モード

| 設定値 | 説明 |
|--------|------|
| **Full Control (統合)** | 体・手・顔の全てを検出。最も詳細だが処理が重い |
| **Simple Pose (簡易)** | 体のみを検出。高速で軽量 |
| **Pose + Hands** | 体と手を検出。顔は不要な場合に |

#### 精度（Model Complexity）

| 値 | 説明 | 処理速度 |
|----|------|----------|
| **0** | 軽量モデル。速度優先 | 最速 |
| **1** | バランス型。通常はこれで十分 | 中間 |
| **2** | 高精度モデル。細部まで正確 | 最遅 |

**推奨**: 画像処理は `2`、動画処理は `1`

#### 閾値（Visibility Threshold）

検出されたキーポイントを描画するかどうかの信頼度の閾値です。

| 値 | 説明 |
|----|------|
| **0.0** | 全てのキーポイントを描画（推奨） |
| **0.3** | 信頼度30%以上のみ描画 |
| **0.5** | 信頼度50%以上のみ描画 |
| **0.8** | 高信頼度のみ描画。隠れた部分は描画しない |

**推奨**: 通常は `0.0` で問題ありません。隠れた部分を除外したい場合は `0.3〜0.5` に設定。

### 描画設定

#### 線の太さ

骨格を結ぶ線の太さ（1〜10ピクセル）

| 値 | 用途 |
|----|------|
| **1-2** | 高解像度画像用、細かい骨格 |
| **3-4** | 標準（デフォルト: 4） |
| **5-10** | 低解像度画像用、目立たせたい場合 |

#### 点の大きさ

関節点の円の半径（1〜15ピクセル）

| 値 | 用途 |
|----|------|
| **1-3** | 控えめな表示 |
| **4-6** | 標準（デフォルト: 6） |
| **7-15** | 強調表示 |

#### 背景色

| 設定 | RGB値 | 用途 |
|------|-------|------|
| **black** | (0, 0, 0) | ControlNet標準。最も一般的 |
| **white** | (255, 255, 255) | 明るい背景が必要な場合 |
| **gray** | (128, 128, 128) | 中間色 |
| **custom** | 任意 | 🎨ボタンで指定 |

#### 単色モード

チェックを入れると、体の部位ごとの色分けをやめて単一色で描画します。

- **オフ**: 部位ごとに異なる色（標準のOpenPoseカラー）
- **オン**: 「骨格色」ボタンで指定した色で全て描画

#### 色ボタン

| ボタン | 対象 | デフォルト色 |
|--------|------|-------------|
| **骨格色** | 体の骨格（単色モード時） | 白 |
| **手の色** | 手のランドマーク | 青 |
| **顔の色** | 顔のメッシュ | 黄 |

### オーバーレイ設定

#### オーバーレイ表示

元画像と骨格画像を重ねて表示します。骨格の位置を確認するのに便利です。

#### 透明度

| 値 | 表示 |
|----|------|
| **0.0** | 元画像のみ |
| **0.5** | 半々でブレンド（デフォルト） |
| **1.0** | 骨格画像のみ |

---

## キーボードショートカット

| キー | 機能 |
|------|------|
| **Ctrl + O** | ファイルを開く |
| **Ctrl + B** | 複数ファイルを選択（バッチ） |
| **F5** | 処理を実行 |
| **Ctrl + Enter** | 画像処理を実行 |
| **Ctrl + Shift + Enter** | 動画処理を実行 |

---

## 使い方

### 画像から骨格を抽出する

1. **画像を読み込む**
   - 「参照...」ボタンをクリック、または画像をドラッグ＆ドロップ
   - 入力プレビューに画像が表示される

2. **設定を調整**
   - モード: 目的に応じて選択
   - 精度: 通常は `2`
   - 閾値: 通常は `0.0`

3. **処理を実行**
   - 「🚀 骨格を抽出」ボタンをクリック（または F5）
   - 処理が完了すると骨格画像がプレビューに表示

4. **結果を確認**
   - 保存先フォルダに PNG（骨格画像）と JSON（キーポイントデータ）が出力される

### 複数画像を一括処理する

1. **複数ファイルを選択**
   - 「複数選択」ボタンで複数ファイルを選択
   - または「フォルダ」ボタンでフォルダ内の画像を全て選択
   - または複数ファイルをドラッグ＆ドロップ

2. **バッチ情報を確認**
   - 「📁 ○○ファイルを処理します」と表示される

3. **処理を実行**
   - 進捗バーで全体の進捗を確認できる

### 動画から骨格を抽出する

1. **動画タブに切り替え**

2. **動画を読み込む**
   - 「参照...」ボタンまたはドラッグ＆ドロップ

3. **設定を調整**
   - 精度: 動画は `1` 推奨（高速化のため）

4. **処理を実行**
   - 骨格動画（MP4）と各フレームの PNG + JSON が出力される

### オーバーレイで確認する

1. 処理を実行後、「オーバーレイ表示」にチェック
2. 透明度スライダーで骨格の濃さを調整
3. 元画像との位置関係を確認

---

## 出力ファイル

### 画像処理時

```
output_poses/
├── 画像名_タイムスタンプ_モード名.png    # 骨格画像
└── 画像名_タイムスタンプ_pose_mp.json   # キーポイントデータ
```

### 動画処理時

```
output_videos/
├── 動画名_モード名.mp4                  # 骨格動画
└── 動画名_frames_モード名/
    ├── frame_00001.png                 # 各フレームの骨格画像
    ├── frame_00001.json                # 各フレームのキーポイント
    ├── frame_00002.png
    ├── frame_00002.json
    └── ...
```

### JSON形式

```json
{
    "version": 1.3,
    "people": [{
        "person_id": [-1],
        "pose_keypoints_2d": [
            x0, y0, confidence0,
            x1, y1, confidence1,
            ...
        ]
    }]
}
```

OpenPose互換形式で、25点のキーポイント（x座標, y座標, 信頼度）が格納されています。

---

## 活用例

### ControlNet（Stable Diffusion）

1. 骨格画像を生成
2. ControlNet の OpenPose モードで使用
3. 同じポーズのAI画像を生成

### モーション解析

1. 動画から骨格を抽出
2. JSON データを解析
3. 関節の動きをトラッキング

### アニメーション参考資料

1. 実写動画から骨格を抽出
2. フレームごとの骨格画像を参考にイラスト作成

---

## よくある質問

### Q: 骨格が検出されない

- 人物が小さすぎる場合があります。画像内で人物が大きく映っているか確認してください。
- 精度を `2` に上げてみてください。

### Q: 処理が遅い

- 精度を `1` または `0` に下げてください。
- モードを「Simple Pose」に変更してください。
- 動画の場合、解像度が高いと時間がかかります。

### Q: 手や顔が検出されない

- モードが「Full Control」または「Pose + Hands」になっているか確認してください。
- 手や顔がはっきり映っている画像を使用してください。

### Q: ドラッグ＆ドロップができない

- tkinterdnd2 がインストールされていない可能性があります。
- `pip install tkinterdnd2` でインストールしてください。
- インストールできない場合は、ボタンからファイルを選択してください。

---

## サポート

無料版、有料版ともにサポートは期待しないでください。
ある程度Pythonを触ったことがある方に使っていただくアプリです。
不具合や要望がありましたら、コメント欄にてお知らせください。
